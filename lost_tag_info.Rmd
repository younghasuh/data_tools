---
title: "Tracking specific tags"
author: "Young Ha Suh"
date: "10/19/2020"
output: github_document
editor_options: 
  chunk_output_type: console
---

### Load libraries
```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(knitr)
library(lubridate)
```

<br>

### Load data

Load tag data and set variables correctly. 

Tag data is generated by downloaded relevant files from the CTT account page (https://account.celltracktech.com/) and running it through `data_manager.py`  in Python to have a merged data set. This process will become available in R soon.

```{r}
oct19 <- read.csv("../data_tools/datafiles/station_beep_merged_oct19.csv" )
oct19$time <- as.POSIXct(oct19$Time ,format="%m/%d/%Y %H:%M", tz = "UTC")
oct19$time_est <- with_tz(oct19$time, "EST") #change from UTC to EST

# Filter to time points after Oct 17, which is the start of data I downloaded
oct <- oct19 %>% 
  filter(time_est > '2020-10-17 00:00:00')
```

| Variable  | Description  |
|------------|-------------------------------------------|
| Time | Date-time object for each beep detected; in UTC |
| RadioId  | Which channel the beep was detected in (refers to each antenna on watertower), ignore for now |
| TagId  | Tag ID of beep |
| TagRSSI  | Signal strength of beep; higher values are better |
| NodeId  | Which node the beep got picked up by |
| Validated | Not sure what this is, ignore for now lol |
| time | Time converted to POSIXct object, in UTC |
| time_est | Time converted to POSIXct object, in EST |


<br>

Load node info
```{r}
node_list <- read.csv("nodes.csv")
```

| Variable  | Description  |
|------------|-------------------------------------------|
| NodeId | Letter code of the node |
| id  | Numerical ID of node, refer to combined node map below |
| lat  | Latitude of node |
| lng  | Longitude of node |

<br>

![Combined node map](nodemap.png)

<br>


### Data wrangling 

Use tidyverse to manipulate data. 

```{r message = FALSE}
# Need to convert to upper case to left join with the node data
oct$NodeId <- toupper(oct$NodeId)
#table(oct$NodeId) # check if it worked

# Add node numerical ID
oct <- oct %>% 
  left_join(node_list, by = "NodeId")
```

<br>

### Look for rows containing specific tag IDs

Change accordingly
```{r}
# Check list of tags detected
# table(oct$TagId)

# set tags
tag1 <- "61342D4C" # -QGA
tag2 <- "342A3478" # -BBX
```

Look for these specific ones

* Tag 1
```{r}
tag1data <- oct %>% 
  filter(TagId == tag1) %>% 
  group_by(NodeId) %>% 
  mutate(timeofday = strftime(time_est, format="%H:%M:%S", tz="EST")) %>% 
  arrange(NodeId, timeofday, -TagRSSI) %>% 
  #filter(TagRSSI > -110) %>%    set if there are too many rows
  select(NodeId, id, TagRSSI, time_est, timeofday, Validated)

oct %>% 
  filter(TagId == tag1) %>% 
  group_by(NodeId) %>% 
  mutate(timeofday = strftime(time_est, format="%H:%M:%S", tz="EST")) %>% 
  arrange(NodeId, timeofday, -TagRSSI) %>% 
  select(NodeId, id, TagRSSI, time_est, timeofday, Validated) %>% 
  kable()


View(tag1data)
```

<br> 

* Tag 2
```{r}
tag2data <- oct %>% 
  filter(TagId == tag2) %>% 
  group_by(NodeId) %>% 
  mutate(timeofday = strftime(time_est, format="%H:%M:%S", tz="EST")) %>% 
  arrange(NodeId, timeofday, -TagRSSI) %>% 
  select(NodeId, id, TagRSSI, time_est, timeofday)

oct %>% 
  filter(TagId == tag2) %>% 
  group_by(NodeId) %>% 
  mutate(timeofday = strftime(time_est, format="%H:%M:%S", tz="EST")) %>% 
  arrange(NodeId, timeofday, -TagRSSI) %>% 
  select(NodeId, id, TagRSSI, time_est, timeofday, Validated) %>% 
  kable()

View(tag2data)
```

